jQuery.easing.jswing=jQuery.easing.swing,jQuery.extend(jQuery.easing,{def:"easeOutQuad",swing:function(a,b,c,d,e){return jQuery.easing[jQuery.easing.def](a,b,c,d,e)},easeInQuad:function(a,b,c,d,e){return d*(b/=e)*b+c},easeOutQuad:function(a,b,c,d,e){return-d*(b/=e)*(b-2)+c},easeInOutQuad:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b+c:-d/2*(--b*(b-2)-1)+c},easeInCubic:function(a,b,c,d,e){return d*(b/=e)*b*b+c},easeOutCubic:function(a,b,c,d,e){return d*((b=b/e-1)*b*b+1)+c},easeInOutCubic:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b+c:d/2*((b-=2)*b*b+2)+c},easeInQuart:function(a,b,c,d,e){return d*(b/=e)*b*b*b+c},easeOutQuart:function(a,b,c,d,e){return-d*((b=b/e-1)*b*b*b-1)+c},easeInOutQuart:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b+c:-d/2*((b-=2)*b*b*b-2)+c},easeInQuint:function(a,b,c,d,e){return d*(b/=e)*b*b*b*b+c},easeOutQuint:function(a,b,c,d,e){return d*((b=b/e-1)*b*b*b*b+1)+c},easeInOutQuint:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b*b+c:d/2*((b-=2)*b*b*b*b+2)+c},easeInSine:function(a,b,c,d,e){return-d*Math.cos(b/e*(Math.PI/2))+d+c},easeOutSine:function(a,b,c,d,e){return d*Math.sin(b/e*(Math.PI/2))+c},easeInOutSine:function(a,b,c,d,e){return-d/2*(Math.cos(Math.PI*b/e)-1)+c},easeInExpo:function(a,b,c,d,e){return 0==b?c:d*Math.pow(2,10*(b/e-1))+c},easeOutExpo:function(a,b,c,d,e){return b==e?c+d:d*(-Math.pow(2,-10*b/e)+1)+c},easeInOutExpo:function(a,b,c,d,e){return 0==b?c:b==e?c+d:(b/=e/2)<1?d/2*Math.pow(2,10*(b-1))+c:d/2*(-Math.pow(2,-10*--b)+2)+c},easeInCirc:function(a,b,c,d,e){return-d*(Math.sqrt(1-(b/=e)*b)-1)+c},easeOutCirc:function(a,b,c,d,e){return d*Math.sqrt(1-(b=b/e-1)*b)+c},easeInOutCirc:function(a,b,c,d,e){return(b/=e/2)<1?-d/2*(Math.sqrt(1-b*b)-1)+c:d/2*(Math.sqrt(1-(b-=2)*b)+1)+c},easeInElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(0==b)return c;if(1==(b/=e))return c+d;if(g||(g=.3*e),h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return-(h*Math.pow(2,10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g))+c},easeOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(0==b)return c;if(1==(b/=e))return c+d;if(g||(g=.3*e),h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return h*Math.pow(2,-10*b)*Math.sin(2*(b*e-f)*Math.PI/g)+d+c},easeInOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(0==b)return c;if(2==(b/=e/2))return c+d;if(g||(g=.3*e*1.5),h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return 1>b?-.5*h*Math.pow(2,10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g)+c:h*Math.pow(2,-10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g)*.5+d+c},easeInBack:function(a,b,c,d,e,f){return void 0==f&&(f=1.70158),d*(b/=e)*b*((f+1)*b-f)+c},easeOutBack:function(a,b,c,d,e,f){return void 0==f&&(f=1.70158),d*((b=b/e-1)*b*((f+1)*b+f)+1)+c},easeInOutBack:function(a,b,c,d,e,f){return void 0==f&&(f=1.70158),(b/=e/2)<1?d/2*b*b*(((f*=1.525)+1)*b-f)+c:d/2*((b-=2)*b*(((f*=1.525)+1)*b+f)+2)+c},easeInBounce:function(a,b,c,d,e){return d-jQuery.easing.easeOutBounce(a,e-b,0,d,e)+c},easeOutBounce:function(a,b,c,d,e){return(b/=e)<1/2.75?7.5625*d*b*b+c:2/2.75>b?d*(7.5625*(b-=1.5/2.75)*b+.75)+c:2.5/2.75>b?d*(7.5625*(b-=2.25/2.75)*b+.9375)+c:d*(7.5625*(b-=2.625/2.75)*b+.984375)+c},easeInOutBounce:function(a,b,c,d,e){return e/2>b?.5*jQuery.easing.easeInBounce(a,2*b,0,d,e)+c:.5*jQuery.easing.easeOutBounce(a,2*b-e,0,d,e)+.5*d+c}});var UserView=Backbone.View.extend({template:_.template('<a href="<%= url %>"><img src="<%= src %>" /></a><div class="Tooltip">You are connected</divj'),className:"UserAvatar",initialize:function(a){this.options=a},render:function(){var a="http://www.twitter.com/"+this.options.username,b=_.extend(this.options,{url:a});return this.$el.append(this.template(b)),"anonymous"!==this.options.username&&this.$el.addClass("is--connected"),this}}),InputField=Backbone.View.extend({className:"InputField",template:_.template('<input type="text" placeholder="Search for a nice place" /><a href="#" class="CenterMapButton js-center-button"></a>'),events:{"click input":"_onSearchClick","click .js-center-button":"_onCenterButtonClick"},initialize:function(a){this.options=a},render:function(){return this.$el.html(this.template),this},_onCenterButtonClick:function(a){a&a.preventDefault(),a&a.stopPropagation(),this.trigger("onCenterButtonClick",this)},_onSearchClick:function(a){a&a.preventDefault(),a&a.stopPropagation(),this.trigger("onSearchClick",this)}}),Comment=Backbone.Model.extend(),Comments=Backbone.Collection.extend({model:Comment,url:"https://arce.cartodb.com/api/v2/sql?q=SELECT *, ST_X(ST_Centroid(the_geom)) as longitude,ST_Y(ST_Centroid(the_geom)) as latitude FROM jp ORDER BY created_at DESC",parse:function(a){return a.rows}}),CommentsView=Backbone.View.extend({className:"CommentsPane is--first-time",events:{"click .js-toggle":"_onToggleClick"},template:'<a href="#" class="ToggleButton js-toggle"></a><div class="CommentsInnerContent"><ul class="CommentList"></ul></div>',initialize:function(){this.comments=new Comments,this.comments.bind("reset",this._onLoadComments,this),this.comments.fetch(),this.model=new Backbone.Model({open:!1}),this.model.on("change:open",this._onChangeOpen,this)},_onLoadComments:function(){this.$el.addClass("has--loaded"),this.render()},_renderComments:function(){var a=this;i=0,this.comments.each(function(b){var c=new CommentView({model:b});c.bind("onClick",function(b){a.trigger("goToCoordinates",b,a)}),i+=1,a.$el.find("ul").append(c.render().$el)})},render:function(){return this.$el.html(_.template(this.template)),this._renderComments(),this},_onChangeOpen:function(){var a=this;this.model.get("open")?(this.$el.hasClass("is--first-time")&&this.$el.find(".CommentItem").each(function(a,b){a>10&&(a=10),$(b).delay(150*a).queue(function(a){$(this).show().addClass("animated-fast fadeInUp"),a()})}),this.$el.animate({right:0},{duration:150,easing:"easeInQuad",complete:function(){a.$el.addClass("is--open"),a.$el.removeClass("is--first-time")}})):this.$el.animate({right:-250},{duration:150,easing:"easeOutQuad",complete:function(){a.$el.removeClass("is--open")}})},_onToggleClick:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("open",!this.model.get("open"))}}),CommentView=Backbone.View.extend({events:{click:"_onMouseClick","click .js-avatar":"_onAvatarClick"},tagName:"li",className:"CommentItem",template:'<div class="Body"><div class="comment"><a class="js-avatar" href="http://twitter.com/<%= screen_name %>"><img class="Avatar" src="<%= profile_image_url %>" /></a><p><% if (name) { %><strong><%= name %></strong>: <% } %><%= comment %></p></div></div><div class="Footer"><%= description %></div>',initialize:function(){},render:function(){var a=this.model.get("comment").length>140?this.model.get("comment").substring(0,140)+"...":this.model.get("comment"),b=_.extend(this.model.toJSON(),{comment:a});return this.$el.append(_.template(this.template,b)),this},_onMouseClick:function(a){a.preventDefault(),a.stopPropagation();var b=[this.model.get("latitude"),this.model.get("longitude")];this.trigger("onClick",b,this)},_onAvatarClick:function(a){a.preventDefault(),a.stopPropagation();var b=this.$el.find(".js-avatar").attr("href");window.location=b}}),InformationPane=Backbone.View.extend({className:"InformationPane",events:{"click .js-close":"_onCloseClick","click .js-help":"_onHelpClick"},template:'<div class="InformationPaneInner"><div class="PaneContent"><h3>Hello, <%= username %>!<a href="#" class="CloseButton js-close">×</a></h3><p>As you may have heard, I\'m planning a trip to Japan at the end of May. It\'ll be my very first time there and my FOMO levels are skyrocketing. What places should I visit? Where should I eat? What are the hidden secrets of this magical and crazy island? Please, help me by adding some of your favorite spots using the search field up there.<span class="TwitterHelp"><br /><br />Also, if you connect this website with your Twitter account I\'ll know who to say thanks to :^)</span><br /><br />どうもありがとう,<br /><a href="http://www.twitter.com/javier">Javier Arce</a></p> <a href="/login" class="Button">Connect with Twitter</a></div><div class="tip-container"><div class="tip"></div></div></div><a href="#" class="help js-help">?</a>',initialize:function(a){this.options=a,this.model=new Backbone.Model({open:"anonymous"===this.options.username?!0:!1}),this.model.on("change:open",this._onChangeOpen,this)},render:function(){var a="anonymous"!==this.options.username?this.options.username:"stranger";this.$el.append(_.template(this.template,{username:a}));var b=this.model.get("open");if(localStorage){var c=localStorage.getItem("japan_trip_help");c&&JSON.parse(c).open===!1&&(b=!1,this.model.set({open:!1},{silent:!0}))}return b&&this.$el.find(".InformationPaneInner").delay(550).fadeIn(250),this},close:function(){this.model.set("open",!1)},_onChangeOpen:function(){var a=this;this.model.get("open")?this.$el.find(".InformationPaneInner").fadeIn(250,function(){a.$el.addClass("is--open")}):(this.$el.find(".InformationPaneInner").fadeOut(250,function(){a.$el.removeClass("is--open")}),localStorage&&localStorage.setItem("japan_trip_help",JSON.stringify({open:this.model.get("open")})))},_onHelpClick:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("open",!this.model.get("open"))},_onCloseClick:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("open",!this.model.get("open"))}}),App=Backbone.View.extend({el:"body",defaults:{places:["Unknown place","Misterious place","Misterious location","Unkown spot","Uncharted spot","Unexplored location","Unnamed location","Exotic place"],mapOptions:{https:!0,zoom:!0,scrollwheel:!0,loaderControl:!1,search:!1,shareable:!1},style:{marker:{radius:7,fillColor:"#f05658",color:"#ffffff",weight:1.5,opacity:.9,fillOpacity:1}},vizjson:"https://arce.cartodb.com/api/v2/viz/84c40c80-e5ef-11e4-a74b-0e853d047bba/viz.json"},placeholder_template:"Why do you think I should go <%= place %><%= username %>?",popup_template:'<div class="Header"><h3><%= name %></h3></div><div class="Body"><div class="Message"><div class="Spinner"></div><div class="Success"><div class="SuccessMessage"><strong>どうもありがとう!</strong></div></div></div><div class="Comment"><img class="Avatar" src="<%= profile_image_url %>" /><%= comment %></div><textarea placeholder="<%= placeholder %>" name="name" rows="8" cols="40"></textarea><div class="Controls"><a href="#" class="Button js-add-place">Add this place</a></div></div><div class="Footer"><%= address %></div>',initialize:function(){_.bindAll(this,"_onVisLoaded","_onPlaceChange","_onClickPlace","_onMapClick","_onMapDblClick","_onFinishedGeocoding","_onMouseOver","_onMouseOut","_canClosePopup","_onFeatureClick","_onFeatureOver","_onFeatureOut"),this._setupModel(),cartodb.createVis("map",this.defaults.vizjson,this.defaults.mapOptions).done(this._onVisLoaded),this.render()},render:function(){"anonymous"!==username&&$("body").addClass("is--logged"),this._renderInputField(),this._renderInformationPane(),this._renderComments(),this._renderUser()},_renderInformationPane:function(){this.informationPane=new InformationPane({username:username}),this.$el.append(this.informationPane.render().$el)},_renderUser:function(){this.user=new UserView({username:username,src:avatar}),this.$el.append(this.user.render().$el)},_renderComments:function(){var a=this;this.comments=new CommentsView,this.comments.bind("goToCoordinates",function(b){a._goTo(17,b)}),this.$el.append(this.comments.render().$el)},_renderInputField:function(){this.searchField=new InputField,this.searchField.bind("onSearchClick",this._closeInformationPane,this),this.searchField.bind("onCenterButtonClick",this._centerMap,this),this.$el.append(this.searchField.render().$el)},_closeInformationPane:function(){this.informationPane.close()},_centerMap:function(){var a=this;this.map.setZoom(7),setTimeout(function(){a.map.panTo([36.1733569352216,137.757568359375])},250)},_killEvent:function(a){a&a.preventDefault(),a&a.stopPropagation()},_setupModel:function(){this.model=new Backbone.Model({selected:null})},_onVisLoaded:function(a,b){this._setupOnPressKey();var c=b[1];c.setInteraction(!0);var d=c.getSubLayer(0);this.map=a.getNativeMap(),this.map.clicked=0,this.map.on("click",this._onMapClick),this.map.on("dblclick",this._onMapDblClick),this._setupLocalStorage(),d.setInteractivity("cartodb_id, name, description, comment, latitude, longitude, profile_image_url, screen_name");var e={sql:"SELECT *, ST_X(ST_Centroid(the_geom)) as longitude,ST_Y(ST_Centroid(the_geom)) as latitude FROM jp"};d.set(e),c.on("mouseover",this._onMouseOver),c.on("mouseout",this._onMouseOut),c.on("featureOut",this._onFeatureOut),c.on("featureOver",this._onFeatureOver),c.on("featureClick",this._onFeatureClick),this.autocomplete=new google.maps.places.Autocomplete(this.searchField.$("input")[0],{componentRestrictions:{country:"jp"}}),google.maps.event.addListener(this.autocomplete,"place_changed",this._onPlaceChange),this.geocoder=new google.maps.Geocoder},_setupLocalStorage:function(){if(localStorage){var a=localStorage.getItem("japan_trip");if(a){var b=JSON.parse(a);this._goTo(b.zoom,[b.lat,b.lng])}this.map.on("moveend",function(a){localStorage.setItem("japan_trip",JSON.stringify({zoom:a.target.getZoom(),lat:a.target.getCenter().lat,lng:a.target.getCenter().lng}))})}},_onFeatureOut:function(a,b,c,d,e){-1!==this.model.get("selected")&&this._canClosePopup()&&(this.model.set("selected",null),this.map.closePopup())},_onMouseOut:function(){$(".leaflet-container").css("cursor","auto")},_onMouseOver:function(){this._canClosePopup()&&$(".leaflet-container").css("cursor","help")},_canClosePopup:function(){return!this.popup||this.popup&&this.popup.options&&1!==this.popup.options.type},_onFeatureClick:function(a,b,c,d,e){this._killEvent(a),this.t&&clearInterval(this.t),this.map.closePopup(),this.model.set("selected",d.cartodb_id),this._openPopup(d.name,d.description,[d.latitude,d.longitude],{type:2,comment:d.comment,profile_image_url:d.profile_image_url,screen_name:d.screen_name},!0)},_onFeatureOver:function(a,b,c,d,e){this._killEvent(a),-1!==this.model.get("selected")&&this.model.get("selected")!==d.cartodb_id&&(this.model.set("selected",d.cartodb_id),this._openPopup(d.name,d.description,[d.latitude,d.longitude],{type:2,comment:d.comment,profile_image_url:d.profile_image_url,screen_name:d.screen_name},!0))},_onFinishedGeocoding:function(a,b,c){var a=[a[0],a[1]];c==google.maps.GeocoderStatus.OK&&b&&b.length>0?this._openPopup(null,b[0].formatted_address,a,{type:1}):this._openPopup(null,"Unknown street",a,{type:1})},_onMapClick:function(a){var b=this;this.map.clicked=this.map.clicked+1,this.informationPane.close(),this.t=setTimeout(function(){if(1===b.map.clicked){b.model.set("selected",-1);var c=[a.latlng.lat,a.latlng.lng],d=new google.maps.LatLng(c[0],c[1]);b.map.clicked=0,b.geocoder.geocode({latLng:d},function(a,d){b._onFinishedGeocoding(c,a,d)})}},250)},_onMapDblClick:function(a){this.map.clicked=0},_getPlaceName:function(a){return a?a:_.shuffle(this.defaults.places)[0]},_getPopupContent:function(a,b,c,d,e){var f="",g=avatar;d&&(f=d.comment,g=d.profile_image_url||avatar);var h=_.template(this.placeholder_template,{place:null!==a?"to "+a:"here",username:"anonymous"!==username?", @"+username:""}),i=_.template(this.popup_template,{name:this._getPlaceName(a),profile_image_url:g,placeholder:h,address:b,comment:f}),j={type:d.type,className:"Popup "+(e?"is--readonly":""),offset:new L.Point(0,0)};return{content:i,options:j}},_onPlaceChange:function(){var a=this.autocomplete.getPlace();if(a.geometry&&(this.model.set("selected",-1),a.geometry.location)){var b=[a.geometry.location.lat(),a.geometry.location.lng()];this._goToCoordinates(b);var c=this;setTimeout(function(){c._openPopup(a.name,a.formatted_address,b,{type:1})},900)}},_openPopup:function(a,b,c,d,e){var f=this._getPopupContent(a,b,c,d,e);this.popup=L.popup(f.options).setLatLng(c).setContent(f.content).openOn(this.map);var g=this;this.map.on("popupclose",function(){g.model.set("selected",null)}),$(".js-add-place").off("click",this._onClickPlace),$(".js-add-place").on("click",function(d){g._onClickPlace(d,a,b,c)})},_onClickPlace:function(a,b,c,d){this._killEvent(a);var e=$(this.popup._container),f={coordinates:d,name:b,address:c,comment:e.find("textarea").val()};if(!f.comment)return void this._shakePopup();var g=this;e.find(".Message").fadeIn(150),$.ajax({url:"/place",data:JSON.stringify(f),type:"POST",contentType:"application/json",dataType:"json"}).done(function(){e.find(".Message .Success").animate({top:0},{duration:100,easing:"easeOutQuad"}),g._addMarker(f)})},_shakePopup:function(){var a=$(this.popup._container);$wrapper=a.find(".leaflet-popup-content-wrapper"),$wrapper.addClass("animated shake"),$wrapper.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$wrapper.removeClass("animated shake")})},_addMarker:function(a){var b=this.defaults.style.marker,c=L.circleMarker(a.coordinates,b);c.addTo(this.map);var d=this._getPopupContent(a.name,a.address,a.coordinates,{type:2,comment:a.comment,profile_image_url:avatar,screen_name:username},!0);c.bindPopup(d.content,d.options)},_goTo:function(a,b){var c=this;this.map.setZoom(a),setTimeout(function(){c.map.panTo(b)},250)},_goToCoordinates:function(a){this.map.panTo(a);var b=this;setTimeout(function(){b.map.setZoom(15)},500)},_setupOnPressKey:function(){var a=this;$(document).on("keyup",function(b){27===b.keyCode&&(a.map.closePopup(),a.informationPane.close())})}});$(function(){app=new App});